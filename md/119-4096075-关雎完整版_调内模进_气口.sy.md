---
show: step
version: 1.0
enable_checker: true
---

# åˆ—è¡¨ - åµŒå¥— embedded

## å›å¿†

- ä¸Šæ¬¡æˆ‘ä»¬äº†è§£äº† 
	- ä¸­å›½äº”å£°è°ƒå¼
	- å®«å•†è§’å¾µç¾½  äº”ç§è°ƒå¼ 

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4087423/uid1190679-20250618-1750204513980) 

- è°ƒæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ

### è°ƒ

- è°ƒå†…çš„éŸ³é˜¶ 
	- å°¤å…¶æ˜¯ äº”å£°è°ƒå¼çš„è°ƒå†…éŸ³é˜¶ 
	- éå¸¸è°ƒå’Œ
	- ä¸ä¼šè·‘è°ƒ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4087423/uid1190679-20250618-1750200278157) 

- å¯ä»¥æ ¹æ®è°ƒæ€§ 
	- å‘å±•å‡º æ›´å¤š ä¹å¥ å—ï¼Ÿ

### æ›´å¤šæ­Œè¯

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4078549/uid1190679-20250517-1747466595293) 

- ä»äºŒè¨€ åˆ° å››è¨€
	- ä»¥å¶ä¸ºç¾
	- å…³å…³/é›é¸ 
	- ç¬¦åˆæ±‰è¯­å‘éŸ³å¤©ç„¶é¡¿æŒ«æ„Ÿ

### å†é—®

- å…ˆæŠŠè€ä»£ç ç»™ä»–
	- åŠ¨æœºä¿ç•™ä¸‹æ¥

```
import mido
from mido import Message, MidiFile, MidiTrack
from mido.midifiles import midifiles

# å®šä¹‰æ¯ä¸ªå­—å¯¹åº”çš„éŸ³ç¬¦ï¼ˆä»¥Cå¤§è°ƒäº”å£°éŸ³é˜¶ä¸ºä¾‹ï¼Œä½“ç°èµ·æ‰¿è½¬åˆï¼‰
# ç¬¬ä¸€å¥ï¼šå¹³ç¨³å¼€å§‹
phrase1_notes = ['C4', 'D4', 'E4', 'D4']
# ç¬¬äºŒå¥ï¼šæ‰¿æ¥å¹¶ç¨å¾®æ¨è¿›
phrase2_notes = ['D4', 'E4', 'G4', 'A4']
# ç¬¬ä¸‰å¥ï¼šè½¬æŠ˜ï¼Œæƒ…ç»ªæœ‰æ‰€æå‡
phrase3_notes = ['G4', 'A4', 'C5', 'D5']
# ç¬¬å››å¥ï¼šå›å½’ä¸æ”¶æŸ
phrase4_notes = ['E4', 'D4', 'C4', 'C4']

# åˆ›å»ºMIDIæ–‡ä»¶å’ŒéŸ³è½¨
mid = MidiFile()
track = MidiTrack()
mid.tracks.append(track)

# è®¾ç½®é€Ÿåº¦ï¼ˆå¾®ç§’/æ‹ï¼‰
tempo_value = mido.bpm2tempo(120)  # è¿™é‡Œè®¾ç½®ä¸º120 BPM
track.append(mido.MetaMessage('set_tempo', tempo=tempo_value))

# å‡½æ•°ï¼šå°†éŸ³ç¬¦æ·»åŠ åˆ°éŸ³è½¨
# åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ éŸ³ç¬¦å­—å…¸ï¼ˆCå¤§è°ƒäº”å£°éŸ³é˜¶ï¼‰
NOTE_MAP = {
    'C4': 60,  # å®«
    'D4': 62,  # å•†
    'E4': 64,  # è§’
    'G4': 67,  # å¾µ
    'A4': 69,  # ç¾½
    'C5': 72,  # é«˜å…«åº¦å®«
    'D5': 74   # æ–°å¢D5æ˜ å°„
}

# ä¿®æ”¹åçš„add_phrase_to_trackå‡½æ•°
def add_phrase_to_track(notes):
    for n in notes:
        midi_note = NOTE_MAP[n]  # é€šè¿‡å­—å…¸è·å–MIDIç¼–å·
        track.append(Message('note_on', note=midi_note, velocity=64, time=0))
        track.append(Message('note_off', note=midi_note, velocity=64, time=480))

# åŸä»£ç ä¸­çš„phraseå®šä¹‰éœ€è¦ä¸å­—å…¸é”®åŒ¹é…ï¼Œä¾‹å¦‚ï¼š
# æ·»åŠ å››å¥è¯—å¯¹åº”çš„éŸ³ç¬¦åˆ°éŸ³è½¨
add_phrase_to_track(phrase1_notes)
add_phrase_to_track(phrase2_notes)
add_phrase_to_track(phrase3_notes)
add_phrase_to_track(phrase4_notes)

# ä¿å­˜MIDIæ–‡ä»¶
mid.save('guanju.mid')
```

- ä»¥æ­¤ pyæ–‡ä»¶ ä¸ºä¸Šä¸‹æ–‡
	- å†æè¦æ±‚

### æè¦æ±‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4078549/uid1190679-20250517-1747489731937) 

- å¼ºè°ƒ `äº”å£°è°ƒå¼` `è°ƒå†…`æ¨¡è¿› 

```
import mido
from mido import Message, MidiFile, MidiTrack

# å®šä¹‰åŸºç¡€åŠ¨æœºï¼ˆ16å­—å¯¹åº”éŸ³ç¬¦ï¼Œä»¥Cå¤§è°ƒäº”å£°éŸ³é˜¶ä¸ºä¾‹ï¼‰
base_motif = [
    'C4', 'D4', 'E4', 'D4',
    'D4', 'E4', 'G4', 'A4',
    'G4', 'A4', 'C5', 'D5',
    'E4', 'D4', 'C4', 'C4'
]

# éŸ³ç¬¦æ˜ å°„å­—å…¸ï¼Œæ¶µç›–å¤šä¸ªå…«åº¦çš„äº”å£°éŸ³é˜¶éŸ³ç¬¦
NOTE_MAP = {
    'C3': 48, 'D3': 50, 'E3': 52, 'G3': 55, 'A3': 57,
    'C4': 60, 'D4': 62, 'E4': 64, 'G4': 67, 'A4': 69,
    'C5': 72, 'D5': 74, 'E5': 76, 'G5': 79, 'A5': 81,
    'C6': 84, 'D6': 86, 'E6': 88, 'G6': 91, 'A6': 93
}

# åˆ›å»ºMIDIæ–‡ä»¶å’ŒéŸ³è½¨
mid = MidiFile()
track = MidiTrack()
mid.tracks.append(track)

# è®¾ç½®é€Ÿåº¦ä¸º120 BPM
tempo = mido.bpm2tempo(120)
track.append(mido.MetaMessage('set_tempo', tempo=tempo))


# å‡½æ•°ï¼šå°†éŸ³ç¬¦åºåˆ—æ·»åŠ åˆ°éŸ³è½¨
def add_notes_to_track(notes):
    for note in notes:
        midi_note = NOTE_MAP[note]
        track.append(Message('note_on', note=midi_note, velocity=64, time=0))
        track.append(Message('note_off', note=midi_note, velocity=64, time=480))


# å‡½æ•°ï¼šè¿›è¡Œäº”å£°è°ƒå¼å†…çš„è°ƒå†…æ¨¡è¿›
def transpose_motif(motif, interval):
    transposed_motif = []
    pentatonic_scale = ['C', 'D', 'E', 'G', 'A']
    reverse_note_map = {v: k for k, v in NOTE_MAP.items()}
    
    for note in motif:
        base = note[:-1]
        octave = int(note[-1])
        current_index = pentatonic_scale.index(base)
        
        # Calculate new position with proper wrapping
        new_index = (current_index + interval) % len(pentatonic_scale)
        octave_adjust = (current_index + interval) // len(pentatonic_scale)
        
        # Calculate target MIDI note
        target_midi = NOTE_MAP[f"{pentatonic_scale[new_index]}4"] + 12 * (octave + octave_adjust - 4)
        
        # Find nearest valid MIDI note
        while target_midi not in reverse_note_map:
            target_midi += 12 if target_midi < min(NOTE_MAP.values()) else -12
        
        transposed_motif.append(reverse_note_map[target_midi])
    
    return transposed_motif


# ç”Ÿæˆ5ç»„åŠ¨æœºå¹¶æ·»åŠ åˆ°éŸ³è½¨
current_motif = base_motif
for i in range(5):
    if i < 4:
        add_notes_to_track(current_motif)
        current_motif = transpose_motif(current_motif, 1)  # æ¯æ¬¡æ¨¡è¿›ä¸€ä¸ªäº”å£°éŸ³é˜¶éŸ³çº§
    else:
        add_notes_to_track(base_motif)  # æœ€åä¸€ç»„è½å›åˆ°åŸå§‹åŠ¨æœº

# ä¿å­˜MIDIæ–‡ä»¶
mid.save('guanju.mid')
```

### æ•ˆæœ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4078549/uid1190679-20250517-1747490719357) 

- å‡†å¤‡å¡«è¯

```
å…³å…³é›é¸ åœ¨æ²³ä¹‹æ´²çªˆçª•æ·‘å¥³å›å­å¥½é€‘å‚å·®è‡èœå·¦å³æµä¹‹çªˆçª•æ·‘å¥³å¯¤å¯æ±‚ä¹‹æ±‚ä¹‹ä¸å¾—å¯¤å¯æ€æœæ‚ å“‰æ‚ å“‰è¾—è½¬åä¾§å‚å·®è‡èœå·¦å³é‡‡ä¹‹çªˆçª•æ·‘å¥³ç´ç‘Ÿå‹ä¹‹å‚å·®è‡èœå·¦å³èŠ¼ä¹‹çªˆçª•æ·‘å¥³é’Ÿé¼“ä¹ä¹‹
```

### å¡«è¯æ•ˆæœ

- æ²¡æœ‰æ°”å£

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4078549/uid1190679-20250517-1747491063083) 

- éœ€è¦æ·»åŠ æ°”å£

### æ°”å£

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4078549/uid1190679-20250517-1747491342610) 

```
import mido
from mido import Message, MidiFile, MidiTrack

# å®šä¹‰åŸºç¡€åŠ¨æœºï¼ˆ16å­—å¯¹åº”éŸ³ç¬¦ï¼Œä»¥Cå¤§è°ƒäº”å£°éŸ³é˜¶ä¸ºä¾‹ï¼‰
base_motif = [
    'C4', 'D4', 'E4', 'D4',
    'D4', 'E4', 'G4', 'A4',
    'G4', 'A4', 'C5', 'D5',
    'E4', 'D4', 'C4', 'C4'
]

# éŸ³ç¬¦æ˜ å°„å­—å…¸ï¼Œæ¶µç›–å¤šä¸ªå…«åº¦çš„äº”å£°éŸ³é˜¶éŸ³ç¬¦
NOTE_MAP = {
    'C3': 48, 'D3': 50, 'E3': 52, 'G3': 55, 'A3': 57,
    'C4': 60, 'D4': 62, 'E4': 64, 'G4': 67, 'A4': 69,
    'C5': 72, 'D5': 74, 'E5': 76, 'G5': 79, 'A5': 81,
    'C6': 84, 'D6': 86, 'E6': 88, 'G6': 91, 'A6': 93
}

# åˆ›å»ºMIDIæ–‡ä»¶å’ŒéŸ³è½¨
mid = MidiFile()
track = MidiTrack()
mid.tracks.append(track)

# è®¾ç½®é€Ÿåº¦ä¸º120 BPM
tempo = mido.bpm2tempo(120)
track.append(mido.MetaMessage('set_tempo', tempo=tempo))


# å‡½æ•°ï¼šå°†éŸ³ç¬¦åºåˆ—æ·»åŠ åˆ°éŸ³è½¨
def add_notes_to_track(notes):
    for note in notes:
        midi_note = NOTE_MAP[note]
        track.append(Message('note_on', note=midi_note, velocity=64, time=0))
        track.append(Message('note_off', note=midi_note, velocity=64, time=480))
    # æ·»åŠ å››æ‹çš„åœé¡¿
    track.append(Message('note_off', note=0, velocity=0, time=4 * 480))


# å‡½æ•°ï¼šè¿›è¡Œäº”å£°è°ƒå¼å†…çš„è°ƒå†…æ¨¡è¿›
def transpose_motif(motif, interval):
    transposed_motif = []
    pentatonic_scale = ['C', 'D', 'E', 'G', 'A']
    reverse_note_map = {v: k for k, v in NOTE_MAP.items()}

    for note in motif:
        base = note[:-1]
        octave = int(note[-1])
        current_index = pentatonic_scale.index(base)

        # Calculate new position with proper wrapping
        new_index = (current_index + interval) % len(pentatonic_scale)
        octave_adjust = (current_index + interval) // len(pentatonic_scale)

        # Calculate target MIDI note
        target_midi = NOTE_MAP[f"{pentatonic_scale[new_index]}4"] + 12 * (octave + octave_adjust - 4)

        # Find nearest valid MIDI note
        while target_midi not in reverse_note_map:
            target_midi += 12 if target_midi < min(NOTE_MAP.values()) else -12

        transposed_motif.append(reverse_note_map[target_midi])

    return transposed_motif


# ç”Ÿæˆ5ç»„åŠ¨æœºå¹¶æ·»åŠ åˆ°éŸ³è½¨
current_motif = base_motif
for i in range(5):
    if i < 4:
        add_notes_to_track(current_motif)
        current_motif = transpose_motif(current_motif, 1)  # æ¯æ¬¡æ¨¡è¿›ä¸€ä¸ªäº”å£°éŸ³é˜¶éŸ³çº§
    else:
        add_notes_to_track(base_motif)  # æœ€åä¸€ç»„è½å›åˆ°åŸå§‹åŠ¨æœº

# ä¿å­˜MIDIæ–‡ä»¶
mid.save('guanju.mid')
```

### æ•ˆæœè¾¾æˆ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4078549/uid1190679-20250517-1747491589928) 


### æ€»ç»“
- è¿™æ¬¡ æˆ‘ä»¬
	- å¯¹äº å…³é› çš„åŸºç¡€åŠ¨æœº
	- è°ƒå†… ä¸Šè¡Œ æ¨¡è¿› 
	- å¾—åˆ° äº† å®Œæ•´çš„ ã€Šå…³é›ã€‹ 

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4096075/uid1190679-20250618-1750247466628) 

- æƒ³ä¸º ã€ŠçŸ­æ­Œè¡Œã€‹ è°±æ›² 
	- åº”è¯¥å¦‚ä½•åšå‘¢ï¼Ÿ
- ä¸‹æ¬¡å†è¯´ ğŸ‘‹