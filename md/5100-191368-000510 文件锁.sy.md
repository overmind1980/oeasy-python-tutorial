---
show: step

version: 1.0
enable_checker: true
---

# æ–‡ä»¶é”
## å›å¿†
- pythonæ‹·è´ç¨‹åºè¿è¡Œæ¯”è¾ƒé¡ºåˆ©
- ä½†æ˜¯ä¸¤ä¸ªè¿›ç¨‹åŒæ—¶å†™çš„åŒä¸€ä¸ªæ–‡ä»¶å¯èƒ½æœ‰é—®é¢˜
- æ¯”å¦‚ä¸¤ä¸ªä¸€èµ·å†™
- åé¢å°±ä¼šè¦†ç›–å‰é¢
- æ€ä¹ˆåŠå‘¢ï¼ŸğŸ¤”

### æœé”

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629959530985)

### æŸ¥çœ‹

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629959563866)

### å¯¼å…¥
- import fcntl
- help(fcntl)

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629959634188)

- è¿™ä¸ªmoduleçš„æ„æ€çœ‹èµ·æ¥æ˜¯
- file control

### å°è¯•

- æ–°å¼€ä¸€ä¸ªæ¸¸ä¹å›­
	- import fcntl
	- f = open("oeasy.txt","wb")
	- fcntl.lockf(f,fcntl.LOCK_EX)
- å†å¼€ä¸€ä¸ªæœ‰æ¸¸ä¹å›­
	- import fcntl
	- f = open("oeasy.txt","wb")
	- fcntl.lockf(f,fcntl.LOCK_EX)
- ç¬¬äºŒä¸ªåœ¨é˜»å¡ç­‰å¾…çš„è¿‡ç¨‹ä¸­
- åªè¦ç¬¬ä¸€ä¸ªä¸å¼€é”
- ç¬¬äºŒä¸ªå°±å•¥éƒ½å¹²ä¸äº†

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629960294186)

### è§£é”

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629960389825)

- ç¬¬ä¸€ä¸ªè§£é”äº† 
- ç¬¬äºŒä¸ªå°±æ’ä¸Šé˜Ÿäº†
- ç„¶åä»–å°±æŠŠæ–‡ä»¶ç»™é”ä¸Šäº†
- ç¬¬ä¸€ä¸ªæƒ³è¦å†å†™
- å°±è¿›å…¥äº†é˜»å¡ç­‰å¾…çš„é˜Ÿåˆ—ä¸­

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629960489191)

- ç³»ç»Ÿæ€ä¹ˆçŸ¥é“åˆ°åº•é”çš„æ˜¯å“ªä¸ªæ–‡ä»¶å‘¢ï¼Ÿ

### ç¡®è®¤æ–‡ä»¶
- openä¹‹åçš„å¾—åˆ°çš„fæœ‰ä¸ªä¸€å±æ€§
- å¯ä»¥ç¡®è®¤å”¯ä¸€çš„file

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629960305192)

### é”çš„ç±»å‹

- æˆ‘æƒ³è¯•è¯•å…¶ä»–ç±»å‹çš„é”
- å¯ä»¥ä¹ˆï¼Ÿ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629964135757)

- çœ‹èµ·æ¥åƒæ˜¯cè¯­è¨€ä¸­æšä¸¾ç±»å‹çš„å€¼
- ç”¨lockfä¸å¯ä»¥
- æ‰¾åˆ°ä¸€ä¸ªflock
- å°±å¯ä»¥ç”¨äº†

### åˆ†äº«é”

- ä¸€ä¸ªterminalç”¨äº†fcntl.LOCK_SHåˆ†äº«é”
- å¦ä¸€ä¸ªæƒ³ä¸Šç‹¬äº«é”fcntl.LOCK_EXä¸è¡Œ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629964420045)

- ä½†æ˜¯è¦ä¸Šåˆ†äº«é”å°±å¯ä»¥

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629964459655)

- æˆ‘ä»¬å†è¯•è¯•NBé”
- ä¸¤ä¸ªterminalå¤ªéº»çƒ¦

### tmux
- åœ¨ç»ˆç«¯é‡Œé¢è¿è¡Œtmuxå¼€å¯
- å·¦å³åˆ†å¼€
	- <kbd>ctrl</kbd>+<kbd>b</kbd>ç„¶å<kbd>%</kbd> 
- å·¦å³åˆ‡æ¢
	- <kbd>ctrl</kbd>+<kbd>b</kbd>ç„¶å<kbd>â†</kbd>
	- <kbd>ctrl</kbd>+<kbd>b</kbd>ç„¶å<kbd>â†’</kbd> 
- ç„¶åå·¦å³åˆ†åˆ«è·‘æ¸¸ä¹åœº

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629966011382) 


### ç‹¬äº«
- å³è¾¹å…ˆæ‹¿åˆ°ä¸€ä¸ªç‹¬äº«é”fcntl.LOCK_EX
- å·¦è¾¹å†å°è¯•å¾—åˆ°ä¸€ä¸ªåˆ†äº«é”fcntl.LOCK_SH
- æœç„¶è¢«é˜»å¡äº†

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629966085652)

- æˆ‘ä»¬å¯ä»¥ç”¨å…·ä½“çš„å€¼æ¥è¿›è¡Œè§£é”ä¹ˆï¼Ÿ

### å…·ä½“æ•°å€¼ 

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629964135757)

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629966199473)

- è§£é”ä¹‹åå·¦è¾¹ç«‹åˆ»é˜»å¡ç»“æŸ
- å¾—åˆ°äº†åˆ†äº«é”
- ä½†æ˜¯æˆ‘ä¸æƒ³è¦é˜»å¡å¯ä»¥ä¹ˆï¼Ÿ

### é˜»å¡
- å…ˆæŸ¥å¸®åŠ©æ‰‹å†Œ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629966483737)

- å¦‚æœ åˆ†äº«é”LOCK_SH æˆ–è€… ç‹¬äº«é”LOCK_EX å’Œ  é˜»å¡æ ‡å¿—LOCK_NB è¿›è¡Œbitwise or (æŒ‰ä½è¿›è¡Œçš„æˆ–è¿ç®—)
- é‚£ä¹ˆè¿™ä¸ªå¦‚æœè¿™ä¸ªé”ä¸èƒ½å¾—åˆ°
- å°±ä¸é˜»å¡äº†
- ç›´æ¥æŠ¥OSError
- æ‰”å‡ºä¸€ä¸ªå¼‚å¸¸
- é”™è¯¯å·å±æ€§è¢«è®¾ç½®ä¸ºEACCSæˆ–è€…EAGAIN
- åŠ¨æ‰‹è¯•è¯•

### æŒ‰ä½æˆ–

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629964135757)

- è¿™äº›æ•°å­—åˆšå¥½æ˜¯æŸä¸ªäºŒè¿›åˆ¶ä½
- å½¼æ­¤ä¹‹é—´ä¸ä¼šå½±å“
- 8ä½æ„æˆä¸€ä¸ªçŠ¶æ€å­—å­—èŠ‚

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629966840783)

### NB
![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629966986698)

- å·¦è¾¹å…ˆç”³è¯·ä¸€ä¸ªç‹¬äº«é”
- å³è¾¹è¦ç”³è¯·ï¼Œæ¨¡å¼é™¤äº†ç‹¬äº«è¿˜åŒ…æ‹¬NB
- NBçš„æ„æ€å°±æ˜¯No Block æ²¡æœ‰é˜»å¡
- ç”³è¯·ä¸åˆ°
- ä¹Ÿä¸é˜»å¡
- ç›´æ¥å¾—åˆ°
	- Errno 11
	- BlockingIOError é˜»å¡ioé”™è¯¯
	- è¿™æ˜¯æ ¹æ®å½“å‰ç³»ç»Ÿæ¥çš„
- è¿™è¯»å†™åˆ°åº•æ€ä¹ˆå¼„çš„ï¼Ÿ

###åˆ†æ

- pythonæ˜¯ç”¨cç¼–è¯‘å¾—åˆ°çš„
- ä¸åŒç³»ç»Ÿæœ‰ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿ
- å½“å‰çš„æ˜¯ubuntu
- pythonæƒ³åœ¨ubuntuä¸‹æ“ä½œæ–‡ä»¶
- å°±å¾—è°ƒç”¨ubuntuçš„ç¨‹åºå‘˜æ¥å£
- ç„¶åå®Œæˆæ–‡ä»¶æ“ä½œ
- ubuntuçš„æ–‡ä»¶æ¥å£åœ¨å“ªé‡Œå‘¢ï¼Ÿ
	- https://docs.python.org/3/library/fcntl.html?highlight=fcntlä¸­æœ‰ä»‹ç»Ã¥
	- https://manpages.debian.org/bullseye/manpages-dev/fcntl.2.en.html

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210826-1629967290956)

### æ€»ç»“ 
- è¿™æ¬¡æˆ‘ä»¬æçš„æ˜¯æ–‡ä»¶è¯»å†™çš„é”å®š
- é çš„æ˜¯fcntlè¿™ä¸ªåŒ…
- å¯ä»¥æœ‰
	- åˆ†äº«é”LOCK_SH
	- ç‹¬äº«é”LOCK_EX
	- é˜»å¡æ ‡å¿—LOCK_NB
	- å–æ¶ˆé”LOCK_UN
- ä¸è¿‡å¾—åˆ°é”äº†ä¹‹å
- ä¹Ÿæ˜¯åœ¨åŸå§‹åŸºç¡€ä¸ŠæŠŠåŸæ¥çš„å†…å®¹æŠ¹æ‰äº†
- æˆ‘æƒ³è¦åŸæ¥çš„éƒ½åœ¨
- æ–°æ¥çš„è¿½åŠ è¿›å»
- å¯ä»¥ä¹ˆï¼ŸğŸ¤”
- ä¸‹æ¬¡å†è¯´ğŸ‘‹