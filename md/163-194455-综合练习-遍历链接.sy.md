---
show: step
version: 1.0
enable_checker: true
---

# xpath è·¯å¾„è¡¨è¾¾å¼

## å›å¿†

- è¿™æ¬¡çœŸçš„çˆ¬äº†ä¸€ä¸ªç½‘ç«™
  - oeasy.org
- å³é”®æ£€æŸ¥å…ƒç´ 
  - è·å– xpath
- çˆ¬å–ä¹‹åè·å¾—å±æ€§ href çš„å€¼
- ç„¶ååˆ‡ç‰‡å¹¶æ‹¼æ¥ä¸ºç»å¯¹é“¾æ¥åœ°å€
- èƒ½æŠŠè¿™äº›é“¾æ¥éƒ½çˆ¬ä¸€éä¹ˆï¼ŸğŸ¤”

### éå†

```
import requests
from lxml import etree
with open("urls.txt") as f:
    urls = f.read().split("\n")
for url in urls:
    response = requests.get(url)
    s_html = response.content.decode("utf-8")
    et_html = etree.HTML(s_html)
    et_target = et_html.xpath(".")
    for element in et_target:
        print(element.tag)
        #attributes = element.attrib
        #f.write("http://localhost/oeasyorg"+attributes["href"][1:] + "\n")
```

- è¿è¡Œå‡ºç°äº† 12 æ¬¡ html èŠ‚ç‚¹
- ä½†æ˜¯åé¢æŠ¥äº†é”™è¯¯
- æœ€åä¸€ä¸ª url å‡ºäº†é—®é¢˜

### è§£å†³

- é—®é¢˜å¯èƒ½æ˜¯ç”±äºæœ€åä¸€ä¸ªé“¾æ¥åé¢æœ‰ä¸ª`\n`
- é€ æˆäº†æœ€åçš„å…ƒç´ æ˜¯ä¸€ä¸ªç©ºå­—ç¬¦ä¸²
- ä½¿ç”¨åˆ‡ç‰‡çš„æ–¹æ³•è§£å†³é—®é¢˜

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20220313-1647159359306)


### æ‰¾åˆ° xpath

- å³é”®`å·¥å…·è½¯ä»¶`çš„é“¾æ¥
- å¤åˆ¶ xpath
- ä¿®æ”¹ä»£ç 
- æŒ‰ç…§åœ°å€
  - è¾“å‡ºé¡¹ç›®

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210902-1630590988087)

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210903-1630651702331)

- æˆ‘æƒ³åšçš„æ˜¯ä¿å­˜
  - è¯¾ç¨‹å
  - çœ‹æ•™ç¨‹ç½‘å€

### éå†

- æ‰“å¼€é“¾æ¥åå†å­˜å‚¨
  - å„æ•™ç¨‹åç§°
  - çœ‹æ•™ç¨‹ç½‘å€

```
import requests
from lxml import etree
with open("urls.txt") as f:
    urls = f.read().split("\n")[0:-1]
for url in urls:
    response = requests.get(url)
    s_html = response.content.decode("utf-8")
    et_html = etree.HTML(s_html)
    et_target = et_html.xpath("/html/body/div/div/div[1]")
    et_target2 = et_html.xpath("/html/body/div/div/div[2]/a[1]")
    print("url----"+url)
    count = 0
    while ( count < len(et_target)):
        print(et_target[count].text)
        print(et_target2[count].text)
        print(et_target2[count].attrib["href"])
        count = count + 1
        print("count====" + str(count))
```
- æœ‰ä¸€ç‚¹é—®é¢˜

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20220329-1648560415651/wm)


- loveè¿™ä¸€é¡µ
- ä¸å…¶ä»–ä¹Ÿä¸åŒ
- æ— æ³•å¾—åˆ°ç›¸åº”çš„é“¾æ¥

### ä¿®æ”¹ä»£ç 

```
import requests
from lxml import etree
with open("urls.txt") as f:
    urls = f.read().split("\n")[1:-1]
for url in urls:
    response = requests.get(url)
    s_html = response.content.decode("utf-8")
    et_html = etree.HTML(s_html)
    et_target = et_html.xpath("/html/body/div/div/div[1]")
    et_target2 = et_html.xpath("/html/body/div/div/div[2]/a[1]")
    print("url----"+url)
    count = 0
    while ( count < len(et_target)):
        print(et_target[count].text)
        print(et_target2[count].text)
        print(et_target2[count].attrib["href"])
        count = count + 1
        print("count====" + str(count))
```

- å°†urls.txtä¸­å¾—åˆ°çš„åˆ—è¡¨è¿›è¡Œè£åˆ‡[1:-1]
	- å‰é¢çš„1 æ’é™¤äº†ç¬¬0ä¸ª
	- åé¢çš„-1 æ’é™¤äº†æœ€åä¸€ä¸ª
- å¯ä»¥æŠŠå„ä¸ªç½‘å€è¾“å‡ºåˆ°å±å¹•
- ç°åœ¨éœ€è¦æŠŠè¾“å‡ºé‡å®šå‘åˆ°æ–‡æœ¬æ–‡ä»¶

### ä¿å­˜åˆ°æŒä¹…æ–‡ä»¶

```
import requests
from lxml import etree
with open("urls.txt") as f:
    urls = f.read().split("\n")[1:-1]
for url in urls:
    response = requests.get(url)
    s_html = response.content.decode("utf-8")
    et_html = etree.HTML(s_html)
    et_target = et_html.xpath("/html/body/div/div/div[1]")
    et_target2 = et_html.xpath("/html/body/div/div/div[2]/a[1]")
    count = len(et_target)
    with open("urls.csv","at") as f:
        for cur in range(0,count):
            print("cur====" + str(cur))
            print(et_target[cur].text)
            print(et_target2[cur].text)
            print(et_target2[cur].attrib["href"])
            s_url = et_target[cur].text + "," \
                  + et_target2[cur].attrib["href"] + "\n"
            f.write(s_url)
```

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20220313-1647160146482)


### å›é¡¾æµç¨‹

- æˆ‘ä»¬å…ˆçˆ¬çš„æ˜¯é¦–é¡µ
  - çˆ¬å‡ºå¾ˆå¤šé“¾æ¥
  - ç„¶åå­˜åˆ° urls.txt çš„é‡Œé¢
- ç„¶åéå† urls é‡Œé¢çš„æ¯ä¸€ä¸ªåœ°å€
  - å¾—åˆ°è¯¾ç¨‹çš„åå­—å’Œé“¾æ¥
  - ç„¶åå…¥åº“
- æˆ‘ç°åœ¨å…ˆæŠŠæ•´ä¸ªæµç¨‹åˆåœ¨ä¸€èµ·
- åšæˆä¸€ä¸ª py æ–‡ä»¶

### å•æ–‡ä»¶

```python
import requests
from lxml import etree
response = requests.get("http://oeasy.org")
print(response.content)
et_html = etree.HTML(response.content)
anchors = et_html.xpath("/html/body/header/nav/ul/li/a")
l_anchors = []
for anchor in anchors:
    l_anchors.append("http://oeasy.org/"+anchor.attrib["href"][2:])

result = []
with open("result.csv","wt") as f:
    f.write("type,url\n")
    for page in l_anchors:
        response = requests.get(page)
        et_html = etree.HTML(response.content)
        target1 = et_html.xpath("/html/body/div/div/div[1]")
        target2 = et_html.xpath("/html/body/div/div/div[2]/a[1]")
        count = 0
        print(len(target1))
        print(len(target2))
        while(count<len(target2)):
            print(target1[count].text,",",target2[count].attrib["href"])
            f.write(target1[count].text+","+target2[count].attrib["href"]+"\n")
            count += 1
```

### å…¥åº“

- æ›´æ–°ç³»ç»Ÿå®‰è£… postgres
- å¯åŠ¨ postgres
- å¹¶ä»¥ postgres ç™»å½•

```
sudo apt update
sudo apt install postgresql
sudo /etc/init.d/postgres start
sudo -u postgres psql
```

- æŸ¥çœ‹æ‰€æœ‰æ•°æ®åº“ database

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210903-1630664944685)

### æŸ¥çœ‹æ•°æ®åº“

```
\l
```

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210903-1630665003642)

- å»ºç«‹æ•°æ®åº“ oeasy
- å¹¶è¿›å…¥

```
create database oeasy;
\l
```

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210903-1630665050881)

### å»ºè¡¨å¹¶å¯¼å…¥æ•°æ®

```
\c oeasy
\dt
```

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210903-1630665134696)

- å»ºè¡¨

```
create table urls(topic varchar, url varchar);
\dt
```

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210903-1630665232801)

- å¯¼å…¥æ•°æ®

```
\copy urls from '/home/shiyanlou/urls.csv' delimiter ',' csv ;
```

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210903-1630665741698)

- æŸ¥è¯¢æ•°æ®

```
select * from urls where topic like '%e%';
select * from urls where length(topic) > '5';
```

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210903-1630665711812)

### æ€»ç»“

- è¿™æ¬¡çœŸçš„çˆ¬äº†ä¸€ä¸ªç½‘ç«™
  - oeasy.org
- å³é”®æ£€æŸ¥å…ƒç´ 
  - è·å– xpath
- çˆ¬å–ä¹‹åè·å¾—å±æ€§ href çš„å€¼
- ç„¶ååˆ‡ç‰‡å¹¶æ‹¼æ¥ä¸ºç»å¯¹é“¾æ¥åœ°å€
- å¹¶ä¸”æŠŠæ¯ä¸€ä¸ªé“¾æ¥éƒ½çˆ¬äº†ä¸€é
- èƒ½å‡ºå»çˆ¬ä¸ªç™¾åº¦ä¹ˆï¼ŸğŸ¤”
- ä¸‹æ¬¡å†è¯´
