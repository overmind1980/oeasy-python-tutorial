---
show: step
version: 1.0
enable_checker: true
---

# psycopg3

## å›å¿†

- ä¸Šæ¬¡ä½¿ç”¨äº†æ¸¸æ ‡
-	é€šè¿‡æ¸¸æ ‡
	- å¯ä»¥å¾—åˆ°selectæŸ¥è¯¢çš„ç»“æœé›†
- è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥
	- é€šè¿‡pythonè¯­è¨€
		- ç›´æ¥æ“ä½œpostgresäº†

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20221229-1672323440515)

- psycopgè¿˜æœ‰ä»€ä¹ˆå¥½ç©çš„å—ğŸ¤”

### å•å¥æ‰§è¡Œ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20221230-1672364540137)

- å¯ä»¥å»è¯•è¯•

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20221230-1672366289657)

### è¿è¡Œç»“æœ

- æœ€å¼€å§‹çš„æ—¶å€™ä¼šæŠ¥é”™
	- å› ä¸ºåå°è¿˜æ²¡æœ‰å°†pgå¯åŠ¨èµ·æ¥

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20221230-1672366298024)

- pg æœåŠ¡å¯åŠ¨èµ·æ¥ä¹‹å
	- å°±å¯ä»¥ é€šè¿‡è¿™ç§ä¸€å¥çš„æ–¹å¼ è¿›è¡Œè¿æ¥äº†

### Conn ä½œä¸ºä¸Šä¸‹æ–‡ç®¡ç†å™¨

- åŸæ¥withæ–¹å¼çš„å¥½å¤„
	- æ˜¯ç»“æŸæ—¶ä¼šè‡ªåŠ¨å…³é—­ç½‘ç»œè¿æ¥

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20221230-1672366495124)

- çº¢æ¡†ä¸­çš„ä»£ç 
	- å¯ä»¥å°†connä½œä¸ºä¸Šä¸‹æ–‡çš„ç®¡ç†å™¨
	- ä»è€Œå›æ»šæˆ–æäº¤ä»£ç 
	- æœ€ç»ˆå…³é—­ç½‘ç»œè¿æ¥

### ç¼–å†™ä»£ç 

```
import psycopg
conninfo = "postgres://postgres:oeasypg@localhost:5432/oeasydb"
with psycopg.connect(conninfo) as conn:
    print("connect!")
    try:
        with conn.cursor() as cur:
            cur.execute("INSERT INTO test('aaa','bbb');")
            cur.execute("INSERT INTO test('ccc','ddd');")
            cur.execute("INSERT INTO test('eee','fff');")
            cur.execute("INSERT ")
            cur.close()
    except BaseException:
        print("rollback")
        conn.rollback()
    else:
        print("commit")
        conn.commit()
    finally:
        conn.close()
```

### æ‰§è¡Œç»“æœ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20230330-1680187146502)

- æŠ¥äº†é”™è¯¯
- è¿›è¡Œäº†å›æ»š

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20230330-1680187164540)

- å‰é¢é‚£äº›å·²ç»æ’å…¥çš„è®°å½•ä¹Ÿä½œåºŸäº†

### æŠ¥é”™æç¤º

- å¦‚æœæƒ³è¦è·å¾—æŠ¥é”™ä¿¡æ¯çš„è¯

```
import psycopg
conninfo = "postgres://postgres:oeasypg@localhost:5432/oeasydb"
with psycopg.connect(conninfo) as conn:
    print("connect!")
    try:
        with conn.cursor() as cur:
            cur.execute("INSERT INTO test('aaa','bbb');")
            cur.execute("INSERT INTO test('ccc','ddd');")
            cur.execute("INSERT INTO test('eee','fff');")
            cur.execute("INSERT ")
            cur.close()
    except BaseException as e:
        print("rollback", e)
        conn.rollback()
    else:
        print("commit")
        conn.commit()
    finally:
        conn.close()
```

- åŠ å…¥çº¢æ¡†ä¸­çš„æç¤º

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20230330-1680187698935)

- è¿è¡Œç»“æœ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20230330-1680187757702)

- å‘ç°é”™è¯¯ä½ç½®
- ä½†æ˜¯è¿™ä½ç½®æœ‰ç‚¹æŒ‡ä»£ä¸æ¸…
	- å¯ä»¥æ›´æ¸…æ™°æ˜¾ç¤ºæŠ¥é”™ä½ç½®

### æŠ¥é”™è¾“å‡º

```
import psycopg
import traceback
conninfo = "postgres://postgres:oeasypg@localhost:5432/oeasydb"
with psycopg.connect(conninfo) as conn:
    print("connect!")
    try:
        with conn.cursor() as cur:
            cur.execute("INSERT INTO test('aaa','bbb');")
            cur.execute("INSERT INTO test('ccc','ddd');")
            cur.execute("INSERT INTO test('eee','fff');")
            cur.execute("INSERT ")
            cur.close()
    except BaseException as e:
        print("rollback", e)
        traceback.print_exc()
        conn.rollback()
    else:
        print("commit")
        conn.commit()
    finally:
        conn.close()
```

- å…·ä½“ä¿®æ”¹ä½ç½®

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20230330-1680188158903)

- æŠ¥é”™ç»“æœ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20230330-1680188197368)

### æ€»ç»“

- è¿™æ¬¡ä½¿ç”¨äº†psycopg3çš„æ ‡å‡†æ¨¡å¼
	- å¦‚æœæˆåŠŸçš„è¯
		- å°±æäº¤
	- å¦åˆ™å°±å›æ»š
	- æœ€ç»ˆå…³é—­æ•°æ®åº“è¿æ¥
- å…³äºä¼ é€’å‚æ•°æœ‰ä»€ä¹ˆæ¨èå—ï¼ŸğŸ¤”
- ä¸‹æ¬¡å†è¯´ï¼ğŸ‘‹