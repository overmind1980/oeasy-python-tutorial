---
show: step
version: 1.0
enable_checker: true
---

# cookieæ•ˆæœ

## å›å¿†ä¸Šæ¬¡

- ä¸Šæ¬¡æŠŠæ’å…¥æ•°æ® æ•´åˆè¿›å…¥äº†æ¨¡å—å½“ä¸­
- å¯ä»¥å¯¹äºå·²ç»å­˜åœ¨çš„æ•°æ®è¿›è¡Œæ›´æ–°å—ï¼ŸğŸ¤”

### ä¿®æ”¹ç½‘é¡µ

```
<!DOCTYPE html>
<html>
	<head>
		<script>
			function delete_user(name){
				f = document.getElementById("f");
				u = document.getElementById("d_un");
				u.value = name;
				f.submit();
			}

			function all_users(){
				document.getElementById("select_none").checked = false;
				objs = document.getElementsByName("users");
				for(var i=0;i<objs.length;i++){
					if (objs[i].type == "checkbox" && objs[i].disabled==false){
						objs[i].checked = true;      
					}           
				}
			}

			function none_users(){
				document.getElementById("select_all").checked = false;
				objs = document.getElementsByName("users");
				for(var i=0;i<objs.length;i++){
					if (objs[i].type == "checkbox" && objs[i].disabled==false){
						objs[i].checked = false;      
					}           
				}
			}
		</script>
	<title>Hello from Flask</title>
	</head>
	<body>
		<form action="/user/add" method="POST">
			username:<input name="username"/><br/>
			password:<input name="password"/><br/>
			<input type="submit" name="regist"><br/>
		</form>

		<form id="f" method="POST" action="/user/del">
			<input id="d_un" name="d_un" type="hidden">
		</form>
		{% if current_user == "admin" %}
		<h1>Hello {{ current_user }}!</h1>
		<form id="d2" method="POST" action="/user/dels">
			<input type="checkbox" onclick="all_users();" id="select_all">select all
			<input type="checkbox" onclick="none_users();" id="select_none">select none
			<input type="submit" value="del selected!">   
			{% for record in l %}
			<p> 
			<input type="checkbox" value="{{ record[0] }}" name="users">
			<a href="./prepareUpdate?username={{record[0]}}"> {{ record[0] }}</a>
			<input type=button value="del" onclick="delete_user('{{record[0]}}')"/>
			</p>
			{% endfor %}
		</form>
		{% else %}
		<h1>You dont have permission</h1>
		{% endif %}
	</body>
</html>
```

### é¡µé¢æ·»åŠ é“¾æ¥

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20230209-1675940619637)

- æ•°æ®æ˜¯å¯ä»¥ä¼ é€’è¿‡å»çš„

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20230209-1675941072260)

### æ¥æ”¶æ•°æ®å¤„ç†å‡½æ•°

- åœ¨ä¼ é€’è¿‡ç¨‹ä¸­
	- åªä¼ é€’ç”¨æˆ·å

```
@app_user.route("/prepareUpdate", methods=['POST', 'GET'])
def prepare_update():
    current_user = session["current_user"]
    username = request.args.get("username")
    if current_user != "admin":
        return "you cannot update " + username
    with pool.connection() as conn:
        with conn.cursor() as cur:
            try:
                sql = "SELECT * FROM login WHERE username=%s"
                t = (username,)
                detail = cur.execute(sql,t).fetchone()
                user = detail[0]
                password = detail[1]
                cur.close()
                conn.close()
            except Exception:
                print(traceback.print_exc())
                cur.close()
                conn.close()
                return  "failed to get " + username
            else:
                return render_template("user_detail.html", user = user, password = password)
```

- æœ€åæäº¤åˆ°user_detail.htmlæ¨¡ç‰ˆ
- æ¥æ”¶å‚æ•°
- å¹¶å‡†å¤‡å¤„ç†

### show_detail.html

```
<!DOCTYPE html>
<html>
<head>
<title>Hello from Flask</title>
</head>
<body>
<form id="d2" method="POST" action="/update">
    <input type="hidden" value="{{ user }}" name="old_username"><br/>
    username:<input type="text" value="{{ user }}" name="username"><br/>
    password:<input type="text" value="{{ password }}" name="password"><br/>
	<input type="submit">
</form>
</body>
</html>
```

- è¡¨å•ä¸­å‡ºç°äº†
	- é€‰ä¸­çš„ç”¨æˆ·åå’Œå¯†ç 

### å…·ä½“çš„æ›´æ–°è¯­å¥

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20230125-1674645436097)

- ç°åœ¨éœ€è¦åœ¨pyæ–‡ä»¶ä¸­å®Œæˆæ›´æ–°åŠŸèƒ½

### æ›´æ–°è¯­å¥



```
@@app_user.route("/update", methods=['POST', 'GET'])
def update():
    current_user = session["current_user"]
    old_username = request.form.get("old_username")
    if current_user != "admin":
        return "you cannot update user" + old_username
    username = request.form.get("username")
    password = request.form.get("password")
    with pool.connection() as conn:
        with conn.cursor() as cur:
            try:
                sql = """UPDATE login SET username=%s,password=%s where username=%s"""
                t = (username,password,old_username)
                cur.execute(sql,t)
                conn.commit()
                cur.close()
                conn.close()
            except Exception:
                print(traceback.print_exc())
                cur.close()
                conn.close()
                return "update " + username + "failed!"
            else:
                return redirect("/user")
```

- ç¡®å®å¯ä»¥æ›´æ–°è®°å½•


## æ€»ç»“

- è¿™æ¬¡æ›´æ–°äº†loginè¡¨ä¸­ç”¨æˆ·çš„è®°å½•
- å¯ä»¥å¯¹loginè¡¨è¿›è¡Œæœç´¢å—ï¼ŸğŸ¤”
- ä¸‹æ¬¡å†è¯´!