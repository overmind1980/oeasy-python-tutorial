---
show: step
version: 1.0
enable_checker: true
---

# opencv

## å›å¿†

- ä¸Šæ¬¡ç ”ç©¶äº†
	- ç›´æ–¹å›¾
	- Histogram
- å°†æ‰€æœ‰çš„åƒç´ ç‚¹
	- æŒ‰ç…§äº®åº¦å€¼åˆ†ç±»
	- å½¢æˆçš„æŸ±å½¢å›¾ å°±æ˜¯ ç›´æ–¹å›¾
- å¯ä»¥æ ¹æ®ç›´æ–¹å›¾ 
	- åŠ¨æ€è®¾ç½®é˜ˆå€¼
	- ç”Ÿæˆå„ç§å›¾å½¢çš„æ¡ˆä¾‹

### è‰²é˜¶å·¥å…·

- Levels

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20240114-1705222605918)

- å…ˆå®ç° 
	- è¾“å…¥ é»‘åœº å’Œ ç™½åœº

### å®˜æ–¹æ–‡æ¡£

- https://helpx.adobe.com/photoshop/using/levels-adjustment.html

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20240114-1705240340901)

### åŸºç¡€æ¶æ„

```
import cv2
import numpy as np

def bpil(value):
    print(value)

def wpil(value):
    print(value)

cv2.namedWindow('levels', cv2.WINDOW_NORMAL)
cv2.createTrackbar('Black Point Input Level', 'levels', 0, 255, bpil)
cv2.createTrackbar('White Point Input Level', 'levels', 0, 255, wpil)
cv2.setTrackbarPos('White Point Input Level', 'levels', 255)
width = 400
height= 300
image = np.ones((height,width),dtype=np.uint8)
for num in range(width):
    image[:,num ] =  0 + num / (width-1)  * 255
while True:
    cv2.imshow('levels', image)
    key = cv2.waitKey(1)
    if key & 0xFF == ord('q'):
        break
cv2.destroyAllWindows()
```

- æ•ˆæœ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20240114-1705223964462)

- å‡†å¤‡å¤„ç†å›è°ƒå‡½æ•°

### å¤„ç†è¾“å…¥é»‘åœºã€ç™½åœº

```
import cv2
import numpy as np

cv2.namedWindow('levels', cv2.WINDOW_NORMAL)
width = 400
height= 300
image = np.ones((height,width),dtype=np.uint8)
for num in range(width):
    image[:,num ] =  0 + num / (width-1)  * 255

def linear(pos,wpilv,bpilv,wpolv,bpolv):
    return bpolv + (pos - bpilv) * (wpolv - bpolv) / (wpilv - bpilv)

def bpil(value):
    wpilv = cv2.getTrackbarPos('White Point Input Level', 'levels')
    bpilv = cv2.getTrackbarPos('Black Point Input Level', 'levels')
    height,width = image.shape[0:2]
    for y in range(height):
        for x in range(width):
            v = image[y,x]
            if v <= bpilv:
                image[y,x] = 0
            elif v >= wpilv:
                image[y,x] = 255
            else:
                image[y,x] = linear(v,wpilv,bpilv,255,0)

def wpil(value):
    wpilv = cv2.getTrackbarPos('White Point Input Level', 'levels')
    bpilv = cv2.getTrackbarPos('Black Point Input Level', 'levels')
    height,width = image.shape[0:2]
    for y in range(height):
        for x in range(width):
            v = image[y,x]
            if v <= bpilv:
                image[y,x] = 0
            elif v >= wpilv:
                image[y,x] = 255
            else:
                image[y,x] = linear(v,wpilv,bpilv,255,0)

cv2.createTrackbar('Black Point Input Level', 'levels', 0, 255, bpil)
cv2.createTrackbar('White Point Input Level', 'levels', 0, 255, wpil)
cv2.setTrackbarPos('White Point Input Level', 'levels', 255)
while True:
    cv2.imshow('levels', image)
    key = cv2.waitKey(1)
    if key & 0xFF == ord('q'):
        break
cv2.destroyAllWindows()
```

- æ•ˆæœ
	- å¢å¤§åå·®
	- é»‘çš„æ›´é»‘ ç™½çš„æ›´ç™½

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20240114-1705225989969)

- è¾“å‡º é»‘ç™½åœº æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ

### è¾“å‡ºé»‘ç™½åœº

```
import cv2
import numpy as np

cv2.namedWindow('levels', cv2.WINDOW_NORMAL)
width = 400
height = 300
image = np.ones((height, width), dtype=np.uint8)
for num in range(width):
    image[:, num] = 0 + num / (width - 1) * 255

def linear(pos, wpilv, bpilv, wpolv, bpolv):
    return int(bpolv + (pos - bpilv) * (wpolv - bpolv) / (wpilv - bpilv))

def process(value):
    width = 400
    height = 300
    for num in range(width):
        image[:, num] = 0 + num / (width - 1) * 255
    wpilv = cv2.getTrackbarPos('White Point Input Level', 'levels')
    bpilv = cv2.getTrackbarPos('Black Point Input Level', 'levels')
    wpolv = cv2.getTrackbarPos('White Point Output Level', 'levels')
    bpolv = cv2.getTrackbarPos('Black Point Output Level', 'levels')
    height, width = image.shape[0:2]
    for y in range(height):
        for x in range(width):
            v = image[y, x]
            #print("v=======",v)
            if v <= bpilv:
                image[y, x] = bpolv
            elif v >= wpilv:
                image[y, x] = wpolv
            else:
                image[y, x] = linear(v, wpilv, bpilv, wpolv, bpolv)
            #print("after===",image[y,x])

cv2.createTrackbar('Black Point Input Level', 'levels', 0, 255, process)
cv2.createTrackbar('White Point Input Level', 'levels', 0, 255, process)
cv2.createTrackbar('Black Point Output Level', 'levels', 0, 255,process)
cv2.createTrackbar('White Point Output Level', 'levels', 0, 255,process)
cv2.setTrackbarPos('Black Point Input Level', 'levels', 0)
cv2.setTrackbarPos('White Point Input Level', 'levels', 255)
cv2.setTrackbarPos('Black Point Output Level', 'levels', 0)
cv2.setTrackbarPos('White Point Output Level', 'levels', 255)
while True:
    cv2.imshow('levels', image)
    key = cv2.waitKey(1)
    if key & 0xFF == ord('q'):
        break
cv2.destroyAllWindows()
```

- è¾“å‡ºæ•ˆæœ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20240114-1705235842126)

- å¯ä»¥åº”ç”¨äºå›¾åƒå—ï¼Ÿ

### åœ¨å›¾åƒä¸Šåº”ç”¨

```
import cv2
import numpy as np

cv2.namedWindow('levels', cv2.WINDOW_NORMAL)
width = 400
height = 300
image = cv2.imread("/home/shiyanlou/gear.jpg",cv2.IMREAD_GRAYSCALE)

def linear(pos, wpilv, bpilv, wpolv, bpolv):
    return int(bpolv + (pos - bpilv) * (wpolv - bpolv) / (wpilv - bpilv))

def process(value):
    width = 400
    height = 300
    image = cv2.imread("/home/shiyanlou/gear.jpg",cv2.IMREAD_GRAYSCALE)
    wpilv = cv2.getTrackbarPos('White Point Input Level', 'levels')
    bpilv = cv2.getTrackbarPos('Black Point Input Level', 'levels')
    wpolv = cv2.getTrackbarPos('White Point Output Level', 'levels')
    bpolv = cv2.getTrackbarPos('Black Point Output Level', 'levels')
    height, width = image.shape[0:2]
    for y in range(height):
        for x in range(width):
            v = image[y, x]
            if v <= bpilv:
                image[y, x] = bpolv
            elif v >= wpilv:
                image[y, x] = wpolv
            else:
                image[y, x] = linear(v, wpilv, bpilv, wpolv, bpolv)
    cv2.imshow('levels', image)

cv2.createTrackbar('Black Point Input Level', 'levels', 0, 255, process)
cv2.createTrackbar('White Point Input Level', 'levels', 0, 255, process)
cv2.createTrackbar('Black Point Output Level', 'levels', 0, 255,process)
cv2.createTrackbar('White Point Output Level', 'levels', 0, 255,process)
cv2.setTrackbarPos('Black Point Input Level', 'levels', 0)
cv2.setTrackbarPos('White Point Input Level', 'levels', 255)
cv2.setTrackbarPos('Black Point Output Level', 'levels', 0)
cv2.setTrackbarPos('White Point Output Level', 'levels', 255)
cv2.imshow('levels', image)
key = cv2.waitKey()
if key & 0xFF == ord('q'):
        cv2.destroyAllWindows()
```

- æ•ˆæœ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20240115-1705284602251)

- Mid-tone ä¸­é—´è°ƒ 
	- å¯ä»¥è¿›è¡Œè°ƒèŠ‚å—ï¼Ÿ

### ä¸­é—´è°ƒçš„è°ƒæ•´

```
import cv2
import numpy as np

cv2.namedWindow('levels', cv2.WINDOW_NORMAL)
width = 400
height = 300
image = np.ones((height, width), dtype=np.uint8)

def linear(pos, wpilv, bpilv, wpolv, bpolv):
    return int(bpolv + (pos - bpilv) * (wpolv - bpolv) / (wpilv - bpilv))

def process(value):
    global image
    width = 400
    height = 300
    for num in range(width):
        image[:, num] = 0 + num / (width - 1) * 255
    wpilv = cv2.getTrackbarPos('White Point Input Level', 'levels')
    bpilv = cv2.getTrackbarPos('Black Point Input Level', 'levels')
    wpolv = cv2.getTrackbarPos('White Point Output Level', 'levels')
    bpolv = cv2.getTrackbarPos('Black Point Output Level', 'levels')
    height, width = image.shape[0:2]
    for y in range(height):
        for x in range(width):
            v = image[y, x]
            if v <= bpilv:
                image[y, x] = bpolv
            elif v >= wpilv:
                image[y, x] = wpolv
            else:
                image[y, x] = linear(v, wpilv, bpilv, wpolv, bpolv)
    cv2.imshow('levels', image)

def midtone_control(value):
    width = 400
    height = 300
    for num in range(width):
        image[:, num] = 0 + num / (width - 1) * 255
    Hin = cv2.getTrackbarPos('White Point Input Level', 'levels')
    Sin = cv2.getTrackbarPos('Black Point Input Level', 'levels')
    Hout = cv2.getTrackbarPos('White Point Output Level', 'levels')
    Sout = cv2.getTrackbarPos('Black Point Output Level', 'levels')
    Mid = cv2.getTrackbarPos("Midtone Control","levels")
    Mt = (Mid - Sin) / (Hin - Mid)
    Sin = min(max(Sin, 0), Hin-2)  # Sin, é»‘åœºé˜ˆå€¼ï¼Œ 0<=Sin<Hin
    Hin = min(Hin, 255)  # Hin, ç™½åœºé˜ˆå€¼ï¼Œ Sin<Hin<=255
    Mt  = min(max(Mt, 0.01), 9.99)  # Mt, ç°åœºè°ƒèŠ‚å€¼ï¼Œ 0.01~9.99
    Sout = min(max(Sout, 0), Hout-2)  # Sout, è¾“å‡ºé»‘åœºé˜ˆå€¼ï¼Œ 0<=Sout<Hout
    Hout = min(Hout, 255)  # Hout, è¾“å‡ºç™½åœºé˜ˆå€¼ï¼Œ Sout<Hout<=255
    difIn = Hin - Sin
    difOut = Hout - Sout
    table = np.zeros(256, np.uint8)
    for i in range(256):
        V1 = min(max(255 * (i-Sin)/difIn,0), 255)  # è¾“å…¥åŠ¨æ€çº¿æ€§æ‹‰ä¼¸
        V2 = 255 * np.power(V1/255, 1/Mt)  # ç°åœºä¼½é©¬è°ƒèŠ‚
        table[i] = min(max(Sout+difOut*V2/255, 0), 255)  # è¾“å‡ºçº¿æ€§æ‹‰ä¼¸
    new_image = cv2.LUT(image, table)
    print(table,new_image)
    cv2.imshow('levels', new_image)

cv2.createTrackbar('Black Point Input Level', 'levels', 0, 255, process)
cv2.createTrackbar('White Point Input Level', 'levels', 0, 255, process)
cv2.createTrackbar('Black Point Output Level', 'levels', 0, 255,process)
cv2.createTrackbar('White Point Output Level', 'levels', 0, 255,process)
cv2.createTrackbar('Midtone Control', 'levels', 0, 255, midtone_control)
cv2.setTrackbarPos('Black Point Input Level', 'levels', 0)
cv2.setTrackbarPos('White Point Input Level', 'levels', 255)
cv2.setTrackbarPos('Black Point Output Level', 'levels', 0)
cv2.setTrackbarPos('White Point Output Level', 'levels', 255)
cv2.setTrackbarPos('Midtone Control', 'levels', 128)
cv2.imshow('levels', image)
cv2.waitKey()
cv2.destroyAllWindows()
```

- ç¡®å®å¯ä»¥è°ƒæ•´

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20240114-1705242116233)


### æ€»ç»“ 

- è¿™æ¬¡ç ”ç©¶äº†å›¾åƒçš„è‰²é˜¶æ•ˆæœ
	- Levels
	- å¯ä»¥è®¾ç½®
		- è¾“å…¥é»‘ç™½åœº
		- è¾“å‡ºé»‘ç™½åœº
		- ä¸­é—´è°ƒç°åœº
	- å›¾åƒå°±ä¼šæœ‰ä¸åŒçš„æ•ˆæœ
- æœ€åå…¶å®å‘ç°ä¸€ç§æœ‰è¶£çš„ä¸œè¥¿å«åšLUT
- è¿™ä¸ªLUTæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼ŸğŸ¤”
- ä¸‹æ¬¡å†è¯´ğŸ‘‹