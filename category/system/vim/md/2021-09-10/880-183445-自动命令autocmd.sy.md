---
show: step
version: 1.0
enable_checker: true
---

# è‡ªåŠ¨å‘½ä»¤ autocommand

## å›å¿†

- ä¸Šæ¬¡æˆ‘ä»¬ç ”ç©¶çš„æ˜¯å¤–éƒ¨å‘½ä»¤grep
	- æœç´¢çš„ç»“æœè¿›å…¥äº†åˆ—è¡¨
	- å¯ä»¥éå†è¿™ä¸ªåˆ—è¡¨
	- ä¹Ÿå¯ä»¥ç»™åˆ—è¡¨ä¸­çš„æ¯ä¸€è¡Œæˆ–è€…æ¯ä¸ªæ–‡ä»¶æ‰§è¡Œå‘½ä»¤
- æˆ‘ä»¬å­¦äº†å¾ˆå¤šçš„å‘½ä»¤
    - æœ‰å†…éƒ¨çš„ä¹Ÿæœ‰å¤–éƒ¨çš„
    - å¯ä»¥åœ¨å‘½ä»¤è¡Œé‡Œé¢æ‰§è¡Œ
    - ä¹Ÿå¯ä»¥æ˜ å°„åˆ°ä¸€ç»„é”®ç›˜åœ¨æ­£å¸¸æ¨¡å¼ä¸‹æ‰§è¡Œ
    - ä½†æ˜¯éƒ½éœ€è¦æŒ‰ä¸‹äº›ä»€ä¹ˆ
- èƒ½å¦ä»€ä¹ˆéƒ½ä¸æŒ‰è‡ªåŠ¨å°±æ‰§è¡Œå‘¢ï¼ŸğŸ¤”

### è‡ªåŠ¨å‘½ä»¤autocmd
- åœ¨å½“å‰ç”¨æˆ·çš„æ’ä»¶ç›®å½•ç¼–è¾‘æ’ä»¶æ–‡ä»¶

```
mkdir -p ~/.vim/ftplugin
vi ~/.vim/ftplugin/log.vim
```

- å®šä¹‰å‡½æ•°

```
function DateInsert()
	$delete
	read !date
endfunction
```

- æ–°å»ºå¹¶æ‰“å¼€logæ–‡ä»¶
	- vi a.log
- è°ƒç”¨å‡½æ•°
	- `:call DateInsert()`
	- ä½†æ˜¯ä»–å¥½åƒä¸è®¤è¯†logæ–‡ä»¶ä¸€æ ·
	- `:function`ä¸­æ²¡æœ‰DateInsert()

### è®¾ç½®filetypeæ–‡ä»¶ç±»å‹

- `:filetype`
	- æŸ¥çœ‹æ–‡ä»¶ç±»å‹æ£€æµ‹æƒ…å†µ
- `:set filetype=log`
	- å¼ºåˆ¶è®¾ç½®æ–‡ä»¶ç±»å‹ä¸ºlog
- `:function DateInsert`
	- è§‚å¯ŸDateInsertå‡½æ•°
- `:call DateInsert()`
	- è°ƒç”¨DateInsert()
- `:visual`
	- å›åˆ°ç¼–è¾‘æ¨¡å¼
![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210802-1627877960861)

- ä½†æ˜¯æ¯æ¬¡éƒ½è¦æ‰‹åŠ¨è®¾ç½®filetypeä¹ˆï¼Ÿ
- èƒ½å¦è‡ªåŠ¨æ£€æµ‹å‘¢ï¼Ÿ

### è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶ç±»å‹filetype

- `:h filetype`

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210802-1627878113532)

- `mkdir ~/.vim/ftdetect`
- `vi ~/.vim/ftdetect/log.vim`
- åœ¨æ–‡ä»¶é‡Œé¢å†™ä¸Š
	- `echo "i am a log!"`
	- `set filetype=log`	
- `vi a.log`

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210802-1627878382575)

- æ£€æµ‹æˆåŠŸ
- `:call DateInsert()`
- å‡½æ•°è°ƒç”¨æˆåŠŸ
- æˆ‘æƒ³æŠŠè¿™ä¸ªå‡½æ•°åšæˆä¸€ä¸ªå‘½ä»¤å¯ä»¥ä¹ˆï¼Ÿ

### åˆ¶ä½œå‘½ä»¤

- `:nnoremap Di :call DateInsert()<CR>`
	- `nnoremap`
		- `n` normal æ­£å¸¸æ¨¡å¼
		- `noremap` ä¸å†é€’å½’æ˜ å°„
    - Di æŒ‡å®šçš„å‘½ä»¤Command
    - :call DateInsert() è°ƒç”¨å‡½æ•°
    - <CR> carriage å›è½¦
- `Di` å¯ä»¥ç”¨
- å†æ¬¡`Di`å¯ä»¥åˆ·æ–°æ—¶é—´
- æˆ‘æƒ³ä¿å­˜çš„æ—¶å€™è‡ªåŠ¨è°ƒç”¨å¯ä»¥ä¹ˆï¼Ÿ

### è‡ªåŠ¨å‘½ä»¤

- `:autocmd BufWritePre *.log call DateInsert()`
	- `autocmd` æ˜¯å‘½ä»¤çš„åå­—
	- `BufWritePre` æ˜¯{events} æ˜¯è§¦å‘æ¡ä»¶ ä¿å­˜`buffer`ä¹‹å‰
	- `*.log` æ˜¯{file_pattern} æ˜¯æ–‡ä»¶æ¨¡å¼ä¸º`*.log`
	- `call DateInsert()` æ˜¯{cmd} å…·ä½“æ‰§è¡Œçš„å‘½ä»¤
- `:wq`
- `cat a.log`
- æœ€æ–°çš„æ—¶é—´å·²ç»å†™åœ¨æœ€åä¸€è¡Œäº†
- ä¸è¿‡è¿™ä¸ªè‡ªåŠ¨å‘½ä»¤æœ€å¥½å†™åœ¨filetypeçš„æ’ä»¶é‡Œé¢

### åˆ é™¤è‡ªåŠ¨å‘½ä»¤
- `:autocmd`	
	- å¯ä»¥æŸ¥çœ‹æ‰€æœ‰çš„è‡ªåŠ¨å‘½ä»¤autocmd
- `:autocmd! FileWritePre *.log`
	- æŠŠä»–å®šä¹‰ä¸ºå•¥éƒ½æ²¡æœ‰
	- ä¹Ÿå°±åˆ é™¤äº†

### é…ç½®æ’ä»¶

- `vi ~/.vim/ftplugin`
- `:autocmd BufWritePre *.log call DateInsert()`
	- ä¸ºä»€ä¹ˆå¼ºè°ƒ`*.log`å‘¢
	- å› ä¸ºå¦‚æœæ˜¯`*`çš„è¯
	- ä¸€æ—¦æ‰“å¼€äº†`log`æ–‡ä»¶
	- ä¿å­˜ä»»ä½•å…¶ä»–æ–‡ä»¶æ—¶éƒ½ä¼šæ‰§è¡Œ`DateInsert()`äº†


### æŸ¥çœ‹å¸®åŠ©
- `:h autocmd`

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210802-1627879118769)

- {group} æˆç»„ è‡ªåŠ¨å‘½ä»¤æˆç»„å¹¶å‘½å å¯çœ
- {events} å…·ä½“çš„è§¦å‘äº‹ä»¶
- {pattern} æ–‡ä»¶æ¨¡å¼
- å…·ä½“è¿™éƒ½å•¥æ„æ€ï¼Ÿ

### æˆç»„è‡ªåŠ¨å‘½ä»¤
- æˆç»„æ˜¯å¯é€‰çš„
- å¯ä»¥æˆç»„ä¹Ÿå¯ä»¥ä¸æˆç»„
- è¿™æ˜¯ç»•å£ä»¤ä¹ˆï¼Ÿ
- æˆ‘ä»¬æ¥çœ‹çœ‹

```
augroup cprograms
	autocmd BufReadPost *.c *.h :set sw=4 sts=4
	autocmd BufReadPost *.cpp :set sw=3 sts=3
augroup END
```

- ä¸Šé¢è¯´çš„æ˜¯åœ¨è¯»å–.cã€.h ä¹‹å
    - è‡ªåŠ¨è®¾ç½®ç¼©è¿›å®½åº¦ä¸º4
- åœ¨è¯»å–.cppä¹‹å
    - è‡ªåŠ¨è®¾ç½®ç¼©è¿›å®½åº¦ä¸º3
- æ€»è€Œè¨€ä¹‹è¿™ä¸¤è‡ªåŠ¨å‘½ä»¤æˆä¸ºäº†ä¸€ä¸ªç»„å«åšcprograms
- ä¹Ÿå¯ä»¥å†™æˆ


```
	autocmd cprograms BufReadPost *.c *.h :set sw=4 sts=4
	autocmd cprograms BufReadPost *.cpp :set sw=3 sts=3
```

- ä¸‹é¢è¿™æ ·å¯ä»¥åˆ é™¤ç»„ä¸­æ‰€æœ‰çš„è‡ªåŠ¨å‘½ä»¤
- `:autocmd! cprograms`

### è§¦å‘äº‹ä»¶events

- `:autocmd BufReadPost *.gsm set filetype=asm`
	- `BufReadPost`æ˜¯è¯»å–ä¹‹å
	- `set filetype=asm`
		- æŠŠgsmæ–‡ä»¶çš„æ–‡ä»¶æ ¼å¼filetypeè®¾ç½®ä¸ºasm
		- gsmæ˜¯gnuçš„assemble language
- `:autocmd Filetype text source ~/.vim/abbrevs.vim`
	- `Filetype text`
		- æ˜¯æ£€æµ‹åˆ°æ–‡ä»¶ç±»å‹ä¸ºæ–‡æœ¬çš„æ—¶å€™
		- `vi a.txt`å¯ä»¥è§¦å‘`Filetype text`
	- `source ~/.vim/abbrevs.vim`
		- åŠ è½½ä¸€äº›ç¼©å†™
- `:autocmd BufNewFile *.[ch] 0read ~/sktletons/skel.c`
	- ` BufNewFile *.[ch]`
		- `BufNewFile` æ–°å»ºç¼“å­˜æ–‡ä»¶çš„æ—¶å€™
	- `*.[ch]` 
		- æ–‡ä»¶ç±»å‹å¯¹åº”`*.cæˆ–è€…*.h`
	- `0read ~/sktletons/skel.c`
		- åŠ è½½cä¸€ä¸ªéª¨æ¶æ–‡ä»¶ä½œä¸ºæ¡†æ¶
		- ç„¶åæ·»çš®åŠ è‚‰
	
### æ–‡ä»¶æ¨¡å¼patterns
- é€šé…ç¬¦wild character	
	- *ä»»æ„å¤šä¸ªå­—ç¬¦æˆ–æ•°å­—
		- *.c
		- *.h
	- ?ä¸€ä¸ªå­—æ¯
		- D???.c
	- .
		- å¯¹åº”ä¸€ä¸ªç‚¹dot 
	- []æˆ–è€…å…³ç³»
		- *.[ch]
	- {}æˆ–è€…å…³ç³»
		- a{b,c}
		- å¯¹åº”abæˆ–ac
	- /
        - åœ¨å¯¹åº”è·¯å¾„ä¸­ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼š
		- ~/.vim/ftplugin/*
		- /home/oeasy/*.txt
### è‡ªåŠ¨å‘½ä»¤çš„åµŒå¥—
- ä¸€èˆ¬æ¥è¯´è‡ªåŠ¨å‘½ä»¤çš„æ‰§è¡Œç»“æœä¸ä¼šè§¦å‘å¦ä¸€ä¸ªè‡ªåŠ¨å‘½ä»¤
- ä½†æ˜¯ï¼Œå¦‚æœä½ åè¦è§¦å‘
- å¯ä»¥åŠ ä¸Š nested
- `:autocmd FileChangedShell * nested edit`
	- æ¯”å¦‚ä½ æ‰“å¼€äº†æ–‡ä»¶æ—¶è§¦å‘äº†è‡ªåŠ¨å‘½ä»¤
	- è‡ªåŠ¨å‘½ä»¤åšå‡ºäº†ä¸€äº›ä¿®æ”¹
	- è¿™äº›ä¿®æ”¹å°±ä¹Ÿä¼šè§¦å‘è¿™ä¸ªäº‹ä»¶

### ä½¿ç”¨æ–‡ä»¶åå’Œæ‰©å±•å
- `touch oeasy.txt oeasy.txt.new`
	- æ–°å»ºä¸¤ä¸ªæ–‡ä»¶
- `vi`
- `:echo expand("%:t")`
	- è¾“å‡ºæ–‡ä»¶å
	- å› ä¸ºç°åœ¨å•¥éƒ½æ²¡æœ‰æ‰€ä»¥å•¥éƒ½æ²¡è¾“å‡º
- `:e oeasy.txt`
	- æ‰“å¼€oeasy.txtè¿›å…¥ç¼“å­˜buffer
- `:echo expand("%:t")`
	- è¾“å‡ºå½“å‰æ–‡ä»¶å
- `:echo "hello i am " . expand("%:t")`
	- è¾“å‡ºä¸€å¥è¯

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210802-1627896494828)

- `autocmd BufReadPost * echo "hello i am " . expand("%:t")`
	- å®šä¹‰è‡ªåŠ¨å‘½ä»¤ 
	- è¯»å–ä»»ä½•æ–‡ä»¶æ ¼å¼çš„æ–‡ä»¶ä¹‹å
	- è¾“å‡ºhello å’Œ å½“å‰æ–‡ä»¶å
- `:h expand`
	- æ˜¾ç¤º`hello i am eval.txt`
- æˆåŠŸ

### å¼ºåˆ¶è§¦å‘
- `:doautocmd BufReadPost oeasy.txt`
	- è™½ç„¶åæ²¡æœ‰æ‰“å¼€`oeasy.txt`
	- ä½†æ˜¯ä»–å¼ºåˆ¶æ‰§è¡Œäº†`BufReadPost oeasy.txt`å¯¹åº”çš„è‡ªåŠ¨å‘½ä»¤`autocmd`
- `:autocmd BufReadPost *.new excute "doautocmd BufReadPost " . expand("<afile>:r")`
	- `autocmd BufReadPost *.new`
		- å®šä¹‰`*.new`æ‰“å¼€ä¹‹åå¯¹åº”çš„è‡ªåŠ¨å‘½ä»¤
	- `excute "doautocmd BufReadPost " . expand("<afile>:r")`
		- æ‰§è¡Œ "doautocmd BufReadPost " . expand("<afile>:r")

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210802-1627897130065)

- å¦‚æœæˆ‘ä»¬æ‰“å¼€`oeasy.txt.new`
- å¼ºåˆ¶æ‰§è¡Œ`oeasy.txt`æ‰“å¼€åçš„è‡ªåŠ¨å‘½ä»¤
- ä¹Ÿå°±æ˜¯`excute "doautocmd BufReadPost oeasy.txt"`

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210802-1627897243725)

### æ‰§è¡Œæ­£å¸¸æ¨¡å¼å‘½ä»¤

- åˆšæ‰æ‰§è¡Œçš„éƒ½æ˜¯å‘½ä»¤è¡Œæ¨¡å¼çš„å‘½ä»¤
- å¦‚æœæˆ‘æƒ³æ‰§è¡Œæ­£å¸¸æ¨¡å¼çš„å‘½ä»¤åº”è¯¥å¦‚ä½•å‘¢ï¼Ÿ
- `:autocmd BufReadPost *.log normal G`
	- è¯»å–`*.log`çš„æ—¶å€™
	- normal G åœ¨æ­£å¸¸æ¨¡å¼ä¸‹æ‰§è¡ŒG
	- è·³åˆ°æœ€åä¸€è¡Œï¼ŒæŸ¥çœ‹æœ€æ–°çš„æ—¥å¿—
- `normal`è¿›å…¥æ­£å¸¸æ¨¡å¼ï¼Œåœ¨æ­£å¸¸æ¨¡å¼ä¸‹
	- <kbd>i</kbd>è¿›å…¥æ’å…¥æ¨¡å¼ <kbd>esc</kbd>é€€å‡º
	- <kbd>:</kbd>è¿›å…¥å‘½ä»¤æ¨¡å¼ <kbd>esc</kbd>é€€å‡º
	- <kbd>/</kbd>è¿›å…¥æœç´¢æ¨¡å¼ <kbd>esc</kbd>é€€å‡º
- `:autocmd BufReadPost *.txt excute "normal ggONew entry:\<Esc>" | 1read !date`
	- `autocmd BufReadPost *.txt `
		- åˆ¶ä½œè¯»å–txtæ–‡ä»¶åå¯¹åº”è‡ªåŠ¨å‘½ä»¤
	- `excute "normal ggONew entry:\<Esc>" | 1read !date`
		- æ‰§è¡Œ`normal ggONew entry:\<Esc>`åœ¨ç¬¬ä¸€è¡Œå†™å­—
		- `|` ç„¶åæ‰§è¡Œ
		- `1read !date` åœ¨ç¬¬äºŒè¡Œå†™æ—¥æœŸ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20210802-1627898210026)

## æ€»ç»“

- è¿™ä¸ªè‡ªåŠ¨å‘½ä»¤è¿˜æ˜¯å¾ˆæ–¹ä¾¿çš„
- æ‰“å¼€æ—¶ã€ä¿å­˜æ—¶å°±ä¼šæœ‰è‡ªåŠ¨æ‰§è¡Œçš„æ“ä½œ
- è‡ªåŠ¨å‘½ä»¤æœ‰è¿™ä¹ˆå‡ å¤§å…ƒç´ 
	- `{event}` è§¦å‘äº‹ä»¶
	- `{pattern}` æ–‡ä»¶æ¨¡å¼
	- `{cmd}` å…·ä½“æ‰§è¡Œå‘½ä»¤
	- `{augroup}` å‘½ä»¤ç»„
- è‡ªåŠ¨å‘½ä»¤å¯ä»¥æ–°å»ºã€åˆ é™¤ã€åˆ—è¡¨ã€æŸ¥è¯¢
- è¿˜å¯ä»¥å¼ºåˆ¶æ‰§è¡Œ
- æœ‰è¿™ä¸ªæˆ‘ä»¬å¯ä»¥
    - é’ˆå¯¹æ¯ç§ä¸åŒçš„æ–‡ä»¶çš„ç±»å‹
    - å®šä¹‰ç›¸åº”çš„è§¦å‘äº‹ä»¶
    - ç„¶åæ‰§è¡Œå„ç§å„æ ·çš„å‘½ä»¤
    - æ–¹ä¾¿æ“ä½œ
- ä¸è¿‡å…³äºæ–‡ä»¶ç±»å‹çš„é«˜äº®æ˜¾ç¤ºè¿˜æ˜¯æ²¡æœ‰è®²çš„ç‰¹åˆ«æ¸…æ¥š
    - ä¸ºä»€ä¹ˆ`public`åœ¨`java`æ–‡ä»¶é‡Œé¢å°±å¯ä»¥æ”¹å˜é¢œè‰²å‘¢ï¼Ÿï¼ŸğŸ¤”
- ä¸‹æ¬¡å†è¯´ï¼





